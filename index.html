<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ratno Fineshyt Game - MULTIPLAYER</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<!-- Firebase SDK - PAKAI COMPAT VERSION -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
:root{
  --cell-size:28px;
  --cols:16;
  --rows:12;
  --bg:#1a1a2e;
  --snake:#00ffa1;
  --accent:#ffd60a;
  --panel:#0b3b5e;
}
html,body{height:100%;margin:0;font-family:Arial, Helvetica, sans-serif;background: var(--bg);display:flex;align-items:center;justify-content:center;}
.wrap{width: calc(var(--cols) * var(--cell-size) + 3rem);max-width: 95vw;background: linear-gradient(145deg,#16162a,#2a2a4d);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.5);padding:20px;position: relative;}

/* Main Menu Styles */
.main-menu{text-align:center;color:#fff;}
.game-title{font-family: 'Press Start 2P', monospace;font-size:24px;color:var(--accent);text-shadow:0 0 10px rgba(255,214,0,0.5);margin-bottom:30px;line-height:1.4;}
.currency-display{display:flex;justify-content:space-between;margin-bottom:30px;font-size:18px;}
.currency-item{display:flex;align-items:center;gap:8px;padding:10px 15px;background:rgba(0,0,0,0.3);border-radius:10px;}
.menu-buttons{display:flex;flex-direction:column;gap:15px;}
.menu-btn{background:linear-gradient(145deg,#444,#555);border:none;padding:18px 25px;border-radius:15px;color:#fff;font-size:18px;font-weight:700;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,0.4);transition:all 0.2s;font-family:'Press Start 2P', monospace;}
.menu-btn:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,0.5);}
.menu-btn:active{transform:translateY(0);}
.menu-btn.play{background:linear-gradient(145deg,#00aa00,#00cc00);font-size:20px;}
.menu-btn.settings{background:linear-gradient(145deg,#555,#666);}
.menu-btn.gacha{background:linear-gradient(145deg,#aa00aa,#cc00cc);}
.menu-btn.skin{background:linear-gradient(145deg,#0088aa,#00aacc);}
.menu-btn.fashion{background:linear-gradient(145deg,#aa8800,#ccaa00);}
.menu-btn.multiplayer{background:linear-gradient(145deg,#0066aa,#0088cc);}

/* Settings Menu Styles */
.settings-menu{display:none;text-align:center;color:#fff;}
.settings-title{font-family: 'Press Start 2P', monospace;font-size:20px;color:var(--accent);margin-bottom:25px;}
.settings-content{display:flex;flex-direction:column;gap:20px;}
.settings-item{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;background:rgba(0,0,0,0.3);border-radius:10px;}
.speed-controls{display:flex;align-items:center;gap:10px;}
.speed-btn{background:linear-gradient(145deg,#444,#555);border:none;padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer;font-size:16px;min-width:40px;}
.settings-back-btn{background:linear-gradient(145deg,#555,#666);border:none;padding:14px 20px;border-radius:12px;color:#fff;font-size:16px;cursor:pointer;margin-top:20px;}

/* Game Screen Styles */
.game-screen{display:none;}
.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;flex-wrap:wrap;gap:10px;}
.title{font-family: 'Press Start 2P', monospace;font-size:22px;color: var(--accent);text-shadow: 0 0 6px rgba(0,0,0,0.7);margin-bottom:6px;line-height:1.3;}
.info{color:#fff;font-size:18px;padding:8px 12px;background: rgba(0,0,0,0.3);border-radius:10px;box-shadow: 0 2px 6px rgba(0,0,0,0.5);margin-bottom:8px;}
.small{font-size:14px;color:#ccc;margin-bottom:10px;}
.board{background: #222;width: calc(var(--cols) * var(--cell-size));height: calc(var(--rows) * var(--cell-size));display:grid;grid-template-columns: repeat(var(--cols), 1fr);grid-template-rows: repeat(var(--rows), 1fr);gap:1px;border-radius:12px;overflow:hidden;margin:0 auto;position: relative;}
.cell{width:100%;height:100%;background: #111;transition: background 0.2s;box-sizing:border-box;display:flex;align-items:center;justify-content:center;font-size:20px;}
.snake{background: var(--snake);border-radius:6px;box-shadow: 0 0 6px var(--snake);}
.head{background: var(--accent);box-shadow: 0 0 8px var(--accent);}
.food{animation: pulse 0.6s infinite alternate;font-size:24px;color:#ffd60a;text-shadow: 0 0 6px #ffd60a, 0 0 12px #ffd60a;}
@keyframes pulse{0%{transform: scale(1);}50%{transform: scale(1.3);}100%{transform: scale(1);}}
.coinAnim{position:absolute;font-size:20px;color:#ffd60a;font-weight:bold;animation: coinMove 0.8s forwards;pointer-events:none;}
@keyframes coinMove{0%{opacity:1; transform: translateY(0);}100%{opacity:0; transform: translateY(-30px);}}
.controls{display:flex;gap:16px;justify-content:center;margin-top:20px;flex-wrap:wrap;}
.btn{background: linear-gradient(145deg,#444,#555);border:none;padding:14px 20px;border-radius:12px;color:#fff;font-weight:700;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,0.4);transition: transform 0.1s;font-size:16px;min-width:80px;}
.btn:active{transform: scale(0.95);}
.arrow-pad{display:grid;grid-template-columns:repeat(3,80px);gap:12px;align-items:center;justify-items:center;}
.arrow{width:80px;height:80px;font-size:32px;border-radius:12px;display:flex;align-items:center;justify-content:center;background: linear-gradient(145deg,#555,#666);color:#fff;font-weight:700;user-select:none;box-shadow:0 3px 6px rgba(0,0,0,0.5);}
.arrow:active{transform: scale(0.95);}
.gameover-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;color:#ff0000;font-family: 'Press Start 2P', monospace;font-size:20px;text-align:center;z-index:10;display:none;padding-top:40px;}
.gameover-overlay button{margin-top:16px;padding:14px 24px;font-family: 'Press Start 2P', monospace;font-size:14px;background:#ff0000;color:#fff;border:none;border-radius:8px;cursor:pointer;box-shadow:0 3px 6px rgba(0,0,0,0.5);}
.shopBtn{margin-top:10px;}

/* Game Over Animation */
.cat-image {
  width: 80px;
  height: 80px;
  margin-bottom: 15px;
  opacity: 0;
  transform: scale(0.5) rotate(-10deg);
  animation: catAppear 0.8s ease-out forwards;
}

@keyframes catAppear {
  0% {
    opacity: 0;
    transform: scale(0.5) rotate(-10deg);
  }
  70% {
    opacity: 1;
    transform: scale(1.1) rotate(5deg);
  }
  100% {
    opacity: 1;
    transform: scale(1) rotate(0deg);
  }
}

.gameover-text {
  color: #ffd60a;
  font-size: 14px;
  margin-bottom: 10px;
  text-shadow: 0 0 10px rgba(255, 214, 0, 0.5);
}

.restart-countdown {
  color: #fff;
  font-size: 14px;
  margin: 8px 0;
  opacity: 0;
  animation: fadeIn 0.5s ease-out 0.8s forwards;
}

.restart-btn {
  opacity: 0;
  transform: translateY(20px);
  animation: slideUp 0.5s ease-out 1.3s forwards;
  font-size: 14px;
  padding: 12px 20px;
}

@keyframes fadeIn {
  to {
    opacity: 1;
  }
}

@keyframes slideUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.settings-menu input[type=checkbox]{transform:scale(1.8);margin-left:10px;}

#coins, #diamonds{font-weight:bold;color:#ffd60a;font-size:18px;}

/* Fashion Menu Styles */
.fashion-menu{display:none;text-align:center;color:#fff;}
.fashion-title{font-family: 'Press Start 2P', monospace;font-size:20px;color:var(--accent);margin-bottom:25px;}
.fashion-content{display:flex;flex-direction:column;gap:20px;align-items:center;}
.effects-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin:20px 0;max-width:400px;}
.effect-item{background:rgba(0,0,0,0.3);border-radius:12px;padding:15px;text-align:center;cursor:pointer;transition:all 0.3s;border:2px solid transparent;}
.effect-item:hover{transform:translateY(-3px);box-shadow:0 5px 15px rgba(0,0,0,0.3);}
.effect-item.active{border-color:#ffd60a;background:rgba(255,214,0,0.1);}
.effect-item.locked{opacity:0.5;cursor:not-allowed;}
.effect-preview{width:80px;height:80px;margin:0 auto 10px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:32px;}
.effect-name{font-size:12px;margin-bottom:5px;color:#fff;}
.effect-status{font-size:10px;color:#ccc;}
.effect-details{display:none;margin-top:15px;padding:10px;background:rgba(0,0,0,0.5);border-radius:8px;font-size:12px;}
.fashion-back-btn{background:linear-gradient(145deg,#555,#666);border:none;padding:14px 20px;border-radius:12px;color:#fff;font-size:16px;cursor:pointer;margin-top:20px;}

/* Effect preview colors */
.effect-fire .effect-preview{background:linear-gradient(145deg,#ff4400,#ff9900);}
.effect-ice .effect-preview{background:linear-gradient(145deg,#00aaff,#00ffff);}
.effect-poison .effect-preview{background:linear-gradient(145deg,#aa00ff,#ff00ff);}
.effect-nature .effect-preview{background:linear-gradient(145deg,#00aa00,#00ff00);}
.effect-default .effect-preview{background:linear-gradient(145deg,#444,#555);}

/* Skin Editor Styles */
.skin-menu{display:none;text-align:center;color:#fff;}
.skin-title{font-family: 'Press Start 2P', monospace;font-size:20px;color:var(--accent);margin-bottom:25px;}
.skin-content{display:flex;flex-direction:column;gap:20px;align-items:center;}
.skin-preview-container{display:flex;flex-direction:column;align-items:center;gap:15px;}
.skin-preview{width:200px;height:200px;border:3px solid var(--accent);border-radius:12px;background:#222;display:flex;align-items:center;justify-content:center;margin:10px auto;overflow:hidden;position:relative;cursor:move;}
.skin-image{max-width:none;position:absolute;cursor:move;user-select:none;transition:transform 0.2s;}
.skin-controls-panel{display:flex;flex-direction:column;gap:10px;margin-top:15px;width:100%;max-width:300px;}
.zoom-controls{display:flex;align-items:center;gap:10px;justify-content:center;}
.zoom-btn{background:linear-gradient(145deg,#444,#555);border:none;padding:8px 12px;border-radius:6px;color:#fff;cursor:pointer;font-size:14px;min-width:40px;}
.zoom-value{font-size:14px;min-width:50px;text-align:center;color:#ffd60a;}
.position-controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
.position-btn{background:linear-gradient(145deg,#444,#555);border:none;padding:8px 12px;border-radius:6px;color:#fff;cursor:pointer;font-size:12px;}
.upload-area{width:100%;max-width:300px;padding:20px;border:2px dashed #ffd60a;border-radius:12px;text-align:center;cursor:pointer;transition:all 0.3s;}
.upload-area:hover{background:rgba(255,214,0,0.1);}
.upload-area.dragover{background:rgba(255,214,0,0.2);border-color:#fff;}
.upload-text{font-size:16px;margin-bottom:10px;}
.upload-btn{background:linear-gradient(145deg,#444,#555);border:none;padding:10px 15px;border-radius:8px;color:#fff;cursor:pointer;font-size:14px;}
.skin-controls{display:flex;gap:15px;margin-top:20px;}
.skin-control-btn{background:linear-gradient(145deg,#444,#555);border:none;padding:12px 18px;border-radius:10px;color:#fff;font-size:14px;cursor:pointer;font-family:'Press Start 2P', monospace;min-width:100px;}
.skin-control-btn.save{background:linear-gradient(145deg,#00aa00,#00cc00);}
.skin-control-btn.reset{background:linear-gradient(145deg,#aa0000,#cc0000);}
.skin-back-btn{background:linear-gradient(145deg,#555,#666);border:none;padding:14px 20px;border-radius:12px;color:#fff;font-size:16px;cursor:pointer;margin-top:20px;}

/* Gacha Menu Styles */
.gacha-menu{display:none;text-align:center;color:#fff;}
.gacha-title{font-family: 'Press Start 2P', monospace;font-size:20px;color:var(--accent);margin-bottom:25px;}
.gacha-content{display:flex;flex-direction:column;gap:20px;align-items:center;}
.gacha-machine{width:300px;height:400px;background:linear-gradient(145deg,#333,#555);border-radius:20px;padding:20px;position:relative;overflow:hidden;border:4px solid #ffd60a;box-shadow:0 10px 30px rgba(0,0,0,0.5);}
.gacha-display{width:100%;height:200px;background:#1a1a2e;border-radius:10px;margin-bottom:20px;overflow:hidden;position:relative;border:2px solid #ffd60a;}
.gacha-items{display:flex;justify-content:space-around;align-items:center;height:100%;padding:0 10px;}
.gacha-item{width:80px;height:80px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:40px;transition:all 0.3s;opacity:0.7;}
.gacha-item.active{transform:scale(1.2);opacity:1;box-shadow:0 0 20px currentColor;}
.gacha-lever{width:60px;height:180px;background:linear-gradient(145deg,#666,#888);position:absolute;right:30px;bottom:20px;border-radius:10px;cursor:pointer;transition:transform 0.3s;}
.gacha-lever:active{transform:rotate(-30deg);}
.gacha-lever-handle{width:40px;height:20px;background:#ffd60a;position:absolute;top:10px;left:10px;border-radius:5px;}
.gacha-options{display:flex;gap:15px;margin-top:20px;}
.gacha-option{background:linear-gradient(145deg,#444,#555);border:none;padding:12px 18px;border-radius:10px;color:#fff;font-size:14px;cursor:pointer;font-family:'Press Start 2P', monospace;min-width:120px;}
.gacha-option:disabled{opacity:0.5;cursor:not-allowed;}
.gacha-option.one-spin{background:linear-gradient(145deg,#aa00aa,#cc00cc);}
.gacha-option.five-spin{background:linear-gradient(145deg,#0088aa,#00aacc);}
.gacha-result{display:none;margin-top:20px;padding:15px;background:rgba(0,0,0,0.3);border-radius:10px;font-size:16px;}
.gacha-back-btn{background:linear-gradient(145deg,#555,#666);border:none;padding:14px 20px;border-radius:12px;color:#fff;font-size:16px;cursor:pointer;margin-top:20px;}

/* Coming Soon Overlay */
.coming-soon-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #ffd60a;
  font-family: 'Press Start 2P', monospace;
  font-size: 20px;
  text-align: center;
  z-index: 100;
  display: none;
}

.coming-soon-overlay .close-btn {
  margin-top: 20px;
  padding: 12px 20px;
  background: #ff0000;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-family: 'Press Start 2P', monospace;
  font-size: 14px;
}

/* Particle Effects */
.particle {
  position: absolute;
  pointer-events: none;
  z-index: 5;
  animation: particleFloat 1.5s ease-out forwards;
}

@keyframes particleFloat {
  0% { 
    transform: translateY(0) scale(0.6) rotate(0deg); 
    opacity: 0.8; 
  }
  50% { 
    transform: translateY(-12px) scale(0.8) rotate(180deg); 
    opacity: 1; 
  }
  100% { 
    transform: translateY(-24px) scale(0.4) rotate(360deg); 
    opacity: 0; 
  }
}

/* Effect classes for snake */
.snake.fire-effect .head {
  background: linear-gradient(145deg, #ff4400, #ff9900);
  box-shadow: 0 0 4px #ff4400, 0 0 6px #ff9900;
}

.snake.ice-effect .head {
  background: linear-gradient(145deg, #00aaff, #00ffff);
  box-shadow: 0 0 4px #00aaff, 0 0 6px #00ffff;
}

.snake.poison-effect .head {
  background: linear-gradient(145deg, #aa00ff, #ff00ff);
  box-shadow: 0 0 4px #aa00ff, 0 0 6px #ff00ff;
}

.snake.nature-effect .head {
  background: linear-gradient(145deg, #00aa00, #00ff00);
  box-shadow: 0 0 4px #00aa00, 0 0 6px #00ff00;
}

/* Custom skin styling */
.snake.custom-skin .head {
  background-size: cover !important;
  background-position: center !important;
}

/* =============== MULTIPLAYER STYLES =============== */
.multiplayer-menu {
  text-align: center;
  color: #fff;
  padding: 20px;
}

.mp-stats {
  display: flex;
  justify-content: center;
  gap: 40px;
  margin: 20px 0;
}

.stat {
  background: rgba(0,0,0,0.3);
  padding: 15px 25px;
  border-radius: 12px;
  min-width: 120px;
}

.stat-value {
  font-size: 32px;
  font-weight: bold;
  color: #ffd60a;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 14px;
  color: #ccc;
}

.mp-options {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin: 30px 0;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
}

.mp-btn {
  background: linear-gradient(145deg, #2a2a4d, #1a1a2e);
  border: 2px solid #444;
  border-radius: 15px;
  padding: 20px;
  color: #fff;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 15px;
  text-align: left;
}

.mp-btn:hover {
  transform: translateY(-5px);
  border-color: #ffd60a;
  box-shadow: 0 5px 15px rgba(255, 214, 0, 0.2);
}

.mp-icon {
  font-size: 32px;
}

.mp-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 5px;
}

.mp-desc {
  font-size: 12px;
  color: #aaa;
}

.room-lobby {
  background: rgba(0,0,0,0.5);
  border-radius: 20px;
  padding: 25px;
  max-width: 600px;
  margin: 0 auto;
}

.player-list {
  background: rgba(0,0,0,0.3);
  border-radius: 12px;
  padding: 15px;
  margin: 20px 0;
  min-height: 200px;
  max-height: 300px;
  overflow-y: auto;
}

.player-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 12px;
  background: rgba(255,255,255,0.1);
  border-radius: 8px;
  margin-bottom: 8px;
  border-left: 4px solid #ffd60a;
}

.player-color {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid #fff;
}

.player-name {
  flex: 1;
  text-align: left;
  font-weight: bold;
}

.lobby-actions {
  display: flex;
  gap: 15px;
  margin-top: 25px;
}

.lobby-btn {
  flex: 1;
  padding: 15px;
  border-radius: 12px;
  border: none;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  font-size: 16px;
}

.copy-link {
  background: linear-gradient(145deg, #0088aa, #00aacc);
}

.start-game {
  background: linear-gradient(145deg, #00aa00, #00cc00);
}

.start-game:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  background: linear-gradient(145deg, #555, #666);
}

.leave-room {
  background: linear-gradient(145deg, #aa0000, #cc0000);
}

.setting-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  margin-bottom: 10px;
}

.setting-item label {
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Firebase Status Indicator */
.firebase-status {
  margin: 10px 0;
  padding: 8px;
  border-radius: 8px;
  font-size: 12px;
  text-align: center;
  font-weight: bold;
}

.firebase-status.connected {
  background: rgba(0, 255, 0, 0.1);
  color: #00ff00;
  border: 1px solid #00ff00;
}

.firebase-status.disconnected {
  background: rgba(255, 0, 0, 0.1);
  color: #ff0000;
  border: 1px solid #ff0000;
}

/* Multiplayer Game HUD */
.multiplayer-hud {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding: 10px;
  background: rgba(0,0,0,0.3);
  border-radius: 10px;
}

.player-list-mini {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.mini-player {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 5px 10px;
  background: rgba(255,255,255,0.1);
  border-radius: 6px;
  font-size: 12px;
}

.mini-color {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 1px solid #fff;
}

.game-timer {
  font-size: 18px;
  font-weight: bold;
  color: #ffd60a;
  padding: 5px 15px;
  background: rgba(0,0,0,0.5);
  border-radius: 8px;
}

/* Room Countdown */
.room-countdown {
  font-size: 24px;
  color: #ffd60a;
  font-weight: bold;
  text-align: center;
  margin: 20px 0;
  animation: pulse 1s infinite;
}

/* Game Starting Overlay */
.game-starting-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.9);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #ffd60a;
  font-family: 'Press Start 2P', monospace;
  z-index: 1000;
  display: none;
}

.start-countdown {
  font-size: 48px;
  margin-bottom: 20px;
}

.start-message {
  font-size: 24px;
  text-align: center;
}

/* Responsive adjustments */
@media (max-width:480px){
  :root{--cell-size:24px; --cols:14; --rows:10;}
  .wrap{padding:16px;}
  .game-title{font-size:20px;}
  .menu-btn{padding:15px 20px;font-size:16px;}
  .menu-btn.play{font-size:18px;}
  .title{font-size:18px;}
  .info{font-size:16px;padding:6px 10px;}
  .small{font-size:12px;}
  .btn{padding:12px 16px;font-size:14px;min-width:70px;}
  .arrow{width:70px;height:70px;font-size:28px;}
  .arrow-pad{grid-template-columns:repeat(3,70px);gap:10px;}
  .cat-image{width:70px;height:70px;}
  .gameover-text{font-size:12px;}
  .restart-countdown{font-size:12px;}
  .gameover-overlay{padding-top:30px;}
  .settings-title{font-size:18px;}
  .gacha-machine{width:250px;height:350px;}
  .gacha-item{width:60px;height:60px;font-size:30px;}
  .skin-preview{width:150px;height:150px;}
  .effects-grid{grid-template-columns:1fr;}
  .mp-options{grid-template-columns:1fr;}
  .mp-stats{flex-direction:column;gap:15px;}
  .lobby-actions{flex-direction:column;}
}

@media (max-width:360px){
  :root{--cell-size:22px; --cols:12; --rows:10;}
  .game-title{font-size:18px;}
  .menu-btn{padding:12px 16px;font-size:14px;}
  .title{font-size:16px;}
  .info{font-size:14px;}
  .btn{padding:10px 14px;font-size:12px;}
  .arrow{width:65px;height:65px;font-size:26px;}
  .arrow-pad{grid-template-columns:repeat(3,65px);}
  .cat-image{width:60px;height:60px;}
  .gameover-text{font-size:11px;}
  .restart-countdown{font-size:11px;}
  .gameover-overlay{padding-top:25px;}
  .settings-title{font-size:16px;}
  .gacha-machine{width:220px;height:320px;}
  .gacha-item{width:50px;height:50px;font-size:25px;}
  .skin-preview{width:120px;height:120px;}
}
</style>
</head>
<body>
<div class="wrap">
  <!-- Main Menu -->
  <div class="main-menu" id="mainMenu">
    <div class="game-title">Ratno<br>Fineshyt Game</div>
    
    <div class="currency-display">
      <div class="currency-item">
        <span>ü™ô</span>
        <span id="menuCoins">0</span>
      </div>
      <div class="currency-item">
        <span>üíé</span>
        <span id="menuDiamonds">0</span>
      </div>
    </div>
    
    <div class="menu-buttons">
      <button class="menu-btn play" id="playBtn">PLAY</button>
      <button class="menu-btn settings" id="menuSettingsBtn">PENGATURAN</button>
      <button class="menu-btn gacha" id="gachaBtn">GACHA</button>
      <button class="menu-btn skin" id="skinBtn">CUSTOM SKIN</button>
      <button class="menu-btn fashion" id="fashionBtn">FASHION</button>
      <button class="menu-btn multiplayer" id="multiplayerBtn">MULTIPLAYER</button>
    </div>
  </div>

  <!-- Settings Menu -->
  <div class="settings-menu" id="settingsMenu" style="display:none;">
    <div class="settings-title">PENGATURAN</div>
    
    <div class="settings-content">
      <div class="settings-item">
        <span>Music</span>
        <input type="checkbox" id="musicToggle">
      </div>
      
      <div class="settings-item">
        <span>Sound Effect</span>
        <input type="checkbox" id="effectToggle">
      </div>
      
      <div class="settings-item">
        <span>Speed</span>
        <div class="speed-controls">
          <button class="speed-btn" id="speedDec">-</button>
          <span id="speedVal">0</span>
          <button class="speed-btn" id="speedInc">+</button>
        </div>
      </div>
    </div>
    
    <button class="settings-back-btn" id="settingsBackBtn">BACK</button>
  </div>

  <!-- Fashion Menu -->
  <div class="fashion-menu" id="fashionMenu" style="display:none;">
    <div class="fashion-title">FASHION - SKIN EFFECT</div>
    
    <div class="fashion-content">
      <div style="font-size:14px;margin-bottom:15px;color:#ccc;">
        Pilih efek yang ingin digunakan. Klik untuk melihat detail.
      </div>
      
      <div class="effects-grid" id="effectsGrid">
        <!-- Effects will be loaded here -->
      </div>
      
      <div style="font-size:12px;color:#ffd60a;margin-top:10px;">
        Efek yang aktif: <span id="activeEffectName">Default</span>
      </div>
    </div>
    
    <button class="fashion-back-btn" id="fashionBackBtn">BACK</button>
  </div>

  <!-- Skin Editor Menu -->
  <div class="skin-menu" id="skinMenu" style="display:none;">
    <div class="skin-title">CUSTOM SKIN EDITOR</div>
    
    <div class="skin-content">
      <div class="skin-preview-container">
        <div>Kotak ini adalah tubuh cacing:</div>
        <div class="skin-preview" id="skinPreview">
          <div style="color:#666;font-size:14px;">Upload gambar untuk memulai</div>
        </div>
        <div class="skin-controls-panel">
          <div class="zoom-controls">
            <button class="zoom-btn" id="zoomOut">-</button>
            <span class="zoom-value" id="zoomValue">100%</span>
            <button class="zoom-btn" id="zoomIn">+</button>
          </div>
          <div class="position-controls">
            <button class="position-btn" id="moveUp">‚Üë</button>
            <button class="position-btn" id="moveLeft">‚Üê</button>
            <button class="position-btn" id="moveRight">‚Üí</button>
            <button class="position-btn" id="moveDown">‚Üì</button>
            <button class="position-btn" id="centerImage">PUSATKAN</button>
            <button class="position-btn" id="resetPosition">RESET</button>
          </div>
        </div>
      </div>
      
      <div class="upload-area" id="uploadArea">
        <div class="upload-text">Upload gambar untuk tubuh cacing</div>
        <input type="file" id="skinUpload" accept="image/*" style="display:none">
        <button class="upload-btn" id="uploadBtn">PILIH GAMBAR</button>
      </div>
      
      <div class="skin-controls">
        <button class="skin-control-btn save" id="saveSkin">SAVE SKIN</button>
        <button class="skin-control-btn reset" id="resetSkin">RESET DEFAULT</button>
      </div>
      
      <div style="font-size:12px;color:#ccc;margin-top:10px;">
        Upload gambar dan atur posisi/zoom untuk kepala cacing
      </div>
    </div>
    
    <button class="skin-back-btn" id="skinBackBtn">BACK</button>
  </div>

  <!-- Gacha Menu -->
  <div class="gacha-menu" id="gachaMenu" style="display:none;">
    <div class="gacha-title">GACHA SPIN</div>
    
    <div class="gacha-content">
      <div class="gacha-machine">
        <div class="gacha-display">
          <div class="gacha-items" id="gachaItems">
            <!-- Items will be loaded here -->
          </div>
        </div>
        <div class="gacha-lever" id="gachaLever">
          <div class="gacha-lever-handle"></div>
        </div>
      </div>
      
      <div class="gacha-options">
        <button class="gacha-option one-spin" id="oneSpin">10 COINS<br>1 SPIN</button>
        <button class="gacha-option five-spin" id="fiveSpin">50 COINS<br>5 SPINS</button>
      </div>
      
      <div class="gacha-result" id="gachaResult">
        <div id="resultText"></div>
        <div id="effectDescription"></div>
      </div>
    </div>
    
    <button class="gacha-back-btn" id="gachaBackBtn">BACK</button>
  </div>

  <!-- Game Screen -->
  <div class="game-screen" id="gameScreen" style="display:none;">
    <div class="header">
      <div>
        <div class="title">Gameplay</div>
        <div class="small">Kontrol: swipe / tombol arah / keyboard</div>
        <div class="small" id="currentEffect">Efek: Default</div>
      </div>
      <div class="hud">
        <div class="info">Score: <span id="score">0</span></div>
        <div class="info">Coins: <span id="coins">0</span> ü™ô</div>
        <button id="restart" class="btn">Restart</button>
        <button id="backToLobby" class="btn" style="display:none;">Kembali ke Lobby</button>
      </div>
    </div>

    <!-- Multiplayer HUD -->
    <div class="multiplayer-hud" id="multiplayerHud" style="display:none;">
      <div class="player-list-mini" id="playerListMini">
        <!-- Mini player list -->
      </div>
      <div class="game-timer" id="gameTimer">05:00</div>
    </div>

    <!-- Board -->
    <div id="board" class="board" tabindex="0">
      <div class="gameover-overlay" id="gameover">
        <img src="assets/images/mati.png" alt="Mati" class="cat-image">
        <div class="gameover-text">Hahahah mati</div>
        <div class="restart-countdown" id="countdown">Kembali ke lobby dalam: 5</div>
        <button class="restart-btn" id="manualRestart">Main Lagi</button>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div style="min-width:200px">
        <div style="font-size:14px;margin-bottom:8px;color:#ccc">Tombol Sentuh</div>
        <div class="arrow-pad" id="touchPad">
          <div></div>
          <div class="arrow" data-dir="up">‚ñ≤</div>
          <div></div>
          <div class="arrow" data-dir="left">‚óÄ</div>
          <div class="arrow" data-dir="down">‚ñº</div>
          <div class="arrow" data-dir="right">‚ñ∂</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Multiplayer Menu -->
  <div class="multiplayer-menu" id="multiplayerMenu" style="display:none;">
    <h2>üéÆ MULTIPLAYER BATTLE ROYALE</h2>
    
    <div class="mp-stats">
      <div class="stat">
        <div class="stat-value" id="onlinePlayers">0</div>
        <div class="stat-label">Online Players</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="activeRooms">0</div>
        <div class="stat-label">Active Games</div>
      </div>
    </div>
    
    <!-- Firebase Status Indicator -->
    <div class="firebase-status" id="firebaseStatus">Checking connection...</div>
    
    <div class="mp-options">
      <button class="mp-btn quick-play" id="quickPlayBtn">
        <div class="mp-icon">‚ö°</div>
        <div class="mp-text">
          <div class="mp-title">QUICK PLAY</div>
          <div class="mp-desc">Join random battle</div>
        </div>
      </button>
      
      <button class="mp-btn create-room" id="createRoomBtn">
        <div class="mp-icon">‚ûï</div>
        <div class="mp-text">
          <div class="mp-title">CREATE ROOM</div>
          <div class="mp-desc">Invite friends</div>
        </div>
      </button>
      
      <button class="mp-btn join-room" id="joinRoomBtn">
        <div class="mp-icon">üîó</div>
        <div class="mp-text">
          <div class="mp-title">JOIN ROOM</div>
          <div class="mp-desc">Enter room code</div>
        </div>
      </button>
      
      <button class="mp-btn leaderboard" id="mpLeaderboardBtn">
        <div class="mp-icon">üèÜ</div>
        <div class="mp-text">
          <div class="mp-title">LEADERBOARD</div>
          <div class="mp-desc">Top players</div>
        </div>
      </button>
    </div>
    
    <button class="menu-btn" id="mpBackBtn" style="margin-top:30px;">‚Üê BACK TO MENU</button>
  </div>

  <!-- Room Lobby -->
  <div class="room-lobby" id="roomLobby" style="display:none;">
    <div class="lobby-header">
      <h3>Room: <span class="room-code" id="lobbyRoomCode">ABC123</span></h3>
      <div class="lobby-status" id="lobbyStatus">Waiting for players...</div>
      <div class="player-count">Players: <span id="lobbyPlayerCount">1/8</span></div>
    </div>
    
    <!-- Room Countdown -->
    <div class="room-countdown" id="roomCountdown" style="display:none;"></div>
    
    <div class="player-list" id="lobbyPlayerList">
      <!-- Players will be added here -->
    </div>
    
    <div class="lobby-settings">
      <h4>Game Settings</h4>
      <div class="setting-item">
        <label>
          <input type="checkbox" id="mapShrink" checked>
          Map Shrink
        </label>
      </div>
      <div class="setting-item">
        <label>
          <input type="checkbox" id="powerUps" checked>
          Power-ups
        </label>
      </div>
      <div class="setting-item">
        <label>Game Time: 
          <select id="gameTime">
            <option value="180">3 minutes</option>
            <option value="300" selected>5 minutes</option>
            <option value="420">7 minutes</option>
          </select>
        </label>
      </div>
    </div>
    
    <div class="lobby-actions">
      <button class="lobby-btn copy-link" id="copyLinkBtn">
        üìã Copy Invite Link
      </button>
      <button class="lobby-btn start-game" id="startGameBtn" disabled>
        üöÄ START GAME
      </button>
      <button class="lobby-btn leave-room" id="leaveLobbyBtn">
        üëã Leave Room
      </button>
    </div>
  </div>
</div>

<!-- Game Starting Overlay -->
<div class="game-starting-overlay" id="gameStartingOverlay" style="display:none;">
  <div class="start-countdown" id="startCountdown">3</div>
  <div class="start-message">Game Starting!</div>
</div>

<!-- Coming Soon Overlay -->
<div class="coming-soon-overlay" id="comingSoon" style="display:none;">
  <div style="font-size:24px;margin-bottom:20px;">COMING SOON</div>
  <div style="font-size:16px;margin-bottom:20px;">Fitur akan segera hadir!</div>
  <button class="close-btn" id="closeComingSoon">TUTUP</button>
</div>

<!-- Audio elements -->
<audio id="bgMusic" loop preload="auto">
  <source src="assets/sounds/music.mp3" type="audio/mpeg">
</audio>
<audio id="eatSfx" preload="auto">
  <source src="assets/sounds/eat.mp3" type="audio/mpeg">
</audio>
<audio id="gameOverSfx" preload="auto">
  <source src="assets/sounds/mati.mp3" type="audio/mpeg">
</audio>
<audio id="buttonSfx" preload="auto">
  <source src="assets/sounds/tombol.mp3" type="audio/mpeg">
</audio>
<audio id="arrowButtonSfx" preload="auto">
  <source src="assets/sounds/tombol2.mp3" type="audio/mpeg">
</audio>
<audio id="gachaWinSfx" preload="auto">
  <source src="assets/sounds/win.mp3" type="audio/mpeg">
</audio>
<audio id="gachaZonkSfx" preload="auto">
  <source src="assets/sounds/zonk.mp3" type="audio/mpeg">
</audio>
<audio id="gachaSpinSfx" preload="auto">
  <source src="assets/sounds/muter.mp3" type="audio/mpeg">
</audio>

<script>
(function(){
  // ==================== ELEMENT REFERENCES ====================
  
  // Screen elements
  const MAIN_MENU = document.getElementById('mainMenu');
  const SETTINGS_MENU = document.getElementById('settingsMenu');
  const FASHION_MENU = document.getElementById('fashionMenu');
  const SKIN_MENU = document.getElementById('skinMenu');
  const GACHA_MENU = document.getElementById('gachaMenu');
  const GAME_SCREEN = document.getElementById('gameScreen');
  const MULTIPLAYER_MENU = document.getElementById('multiplayerMenu');
  const ROOM_LOBBY = document.getElementById('roomLobby');
  const COMING_SOON = document.getElementById('comingSoon');
  const GAME_STARTING_OVERLAY = document.getElementById('gameStartingOverlay');
  
  // Buttons
  const PLAY_BTN = document.getElementById('playBtn');
  const MENU_SETTINGS_BTN = document.getElementById('menuSettingsBtn');
  const FASHION_BTN = document.getElementById('fashionBtn');
  const SKIN_BTN = document.getElementById('skinBtn');
  const GACHA_BTN = document.getElementById('gachaBtn');
  const MULTIPLAYER_BTN = document.getElementById('multiplayerBtn');
  
  // Back buttons
  const SETTINGS_BACK_BTN = document.getElementById('settingsBackBtn');
  const FASHION_BACK_BTN = document.getElementById('fashionBackBtn');
  const SKIN_BACK_BTN = document.getElementById('skinBackBtn');
  const GACHA_BACK_BTN = document.getElementById('gachaBackBtn');
  const MULTIPLAYER_BACK_BTN = document.getElementById('mpBackBtn');
  const CLOSE_COMING_SOON = document.getElementById('closeComingSoon');
  
  // Multiplayer elements
  const QUICK_PLAY_BTN = document.getElementById('quickPlayBtn');
  const CREATE_ROOM_BTN = document.getElementById('createRoomBtn');
  const JOIN_ROOM_BTN = document.getElementById('joinRoomBtn');
  const MP_LEADERBOARD_BTN = document.getElementById('mpLeaderboardBtn');
  const LOBBY_ROOM_CODE = document.getElementById('lobbyRoomCode');
  const LOBBY_PLAYER_LIST = document.getElementById('lobbyPlayerList');
  const LOBBY_PLAYER_COUNT = document.getElementById('lobbyPlayerCount');
  const LOBBY_STATUS = document.getElementById('lobbyStatus');
  const COPY_LINK_BTN = document.getElementById('copyLinkBtn');
  const START_GAME_BTN = document.getElementById('startGameBtn');
  const LEAVE_LOBBY_BTN = document.getElementById('leaveLobbyBtn');
  const FIREBASE_STATUS = document.getElementById('firebaseStatus');
  const ROOM_COUNTDOWN = document.getElementById('roomCountdown');
  const START_COUNTDOWN = document.getElementById('startCountdown');
  const MULTIPLAYER_HUD = document.getElementById('multiplayerHud');
  const PLAYER_LIST_MINI = document.getElementById('playerListMini');
  const GAME_TIMER = document.getElementById('gameTimer');
  const BACK_TO_LOBBY = document.getElementById('backToLobby');
  
  // Game elements
  const BOARD = document.getElementById('board');
  const SCORE = document.getElementById('score');
  const RESTART = document.getElementById('restart');
  const GAMEOVER = document.getElementById('gameover');
  const COUNTDOWN = document.getElementById('countdown');
  const CURRENT_EFFECT = document.getElementById('currentEffect');
  const MANUAL_RESTART = document.getElementById('manualRestart');
  
  // Settings elements
  const speedValEl = document.getElementById('speedVal');
  const speedInc = document.getElementById('speedInc');
  const speedDec = document.getElementById('speedDec');
  const musicToggle = document.getElementById('musicToggle');
  const effectToggle = document.getElementById('effectToggle');
  
  // Fashion elements
  const EFFECTS_GRID = document.getElementById('effectsGrid');
  const ACTIVE_EFFECT_NAME = document.getElementById('activeEffectName');
  
  // Skin editor elements
  const SKIN_PREVIEW = document.getElementById('skinPreview');
  const UPLOAD_BTN = document.getElementById('uploadBtn');
  const SKIN_UPLOAD = document.getElementById('skinUpload');
  const SAVE_SKIN = document.getElementById('saveSkin');
  const RESET_SKIN = document.getElementById('resetSkin');
  const ZOOM_IN = document.getElementById('zoomIn');
  const ZOOM_OUT = document.getElementById('zoomOut');
  const ZOOM_VALUE = document.getElementById('zoomValue');
  const MOVE_UP = document.getElementById('moveUp');
  const MOVE_LEFT = document.getElementById('moveLeft');
  const MOVE_RIGHT = document.getElementById('moveRight');
  const MOVE_DOWN = document.getElementById('moveDown');
  const CENTER_IMAGE = document.getElementById('centerImage');
  const RESET_POSITION = document.getElementById('resetPosition');
  
  // Gacha elements
  const GACHA_ITEMS = document.getElementById('gachaItems');
  const GACHA_LEVER = document.getElementById('gachaLever');
  const ONE_SPIN = document.getElementById('oneSpin');
  const FIVE_SPIN = document.getElementById('fiveSpin');
  const GACHA_RESULT = document.getElementById('gachaResult');
  const RESULT_TEXT = document.getElementById('resultText');
  const EFFECT_DESC = document.getElementById('effectDescription');
  
  // Audio elements
  const bgMusic = document.getElementById('bgMusic');
  const eatSfx = document.getElementById('eatSfx');
  const gameOverSfx = document.getElementById('gameOverSfx');
  const buttonSfx = document.getElementById('buttonSfx');
  const arrowButtonSfx = document.getElementById('arrowButtonSfx');
  const gachaWinSfx = document.getElementById('gachaWinSfx');
  const gachaZonkSfx = document.getElementById('gachaZonkSfx');
  const gachaSpinSfx = document.getElementById('gachaSpinSfx');
  
  // Currency elements
  const MENU_COINS = document.getElementById('menuCoins');
  const MENU_DIAMONDS = document.getElementById('menuDiamonds');
  const GAME_COINS = document.getElementById('coins');
  
  // ==================== GAME VARIABLES ====================
  
  let cols = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cols')) || 16;
  let rows = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--rows')) || 12;
  let cells = [];
  let gridSize = cols*rows;
  
  // Load settings and currency from localStorage
  let speed = parseInt(localStorage.getItem('snake_speed')) || 120;
  let musicOn = localStorage.getItem('snake_music') !== 'false'; // default true
  let effectOn = localStorage.getItem('snake_effect') !== 'false'; // default true
  let coins = parseInt(localStorage.getItem('snake_coins')) || 0;
  let diamonds = parseInt(localStorage.getItem('snake_diamonds')) || 0;
  let currentEffect = localStorage.getItem('snake_effect_current') || 'default';
  let customSkin = localStorage.getItem('snake_custom_skin') || null;
  let unlockedEffects = JSON.parse(localStorage.getItem('snake_unlocked_effects')) || ['default'];
  
  // Skin editor variables
  let currentSkinImage = null;
  let skinZoom = 1;
  let skinPosition = { x: 0, y: 0 };
  let isDragging = false;
  let dragStart = { x: 0, y: 0 };
  
  // Multiplayer variables
  let multiplayer = {
    roomId: null,
    playerId: null,
    playerName: `Player${Math.floor(Math.random() * 1000)}`,
    isHost: false,
    gameLoop: null,
    playerColor: '#00ffa1'
  };
  
  // Firebase variables
  let firebaseApp = null;
  let firebaseDatabase = null;
  let isFirebaseConnected = false;
  let roomListener = null;
  
  // Multiplayer game variables
  let multiplayerPlayers = {};
  let gameStartTime = null;
  let gameDuration = 300; // 5 minutes default
  let gameTimerInterval = null;
  
  // Define available effects
  const effects = [
    { 
      id: 'default', 
      name: 'Default', 
      description: 'Efek standar tanpa partikel',
      icon: 'üêç',
      color: '#00ffa1',
      unlocked: true
    },
    { 
      id: 'fire', 
      name: 'Fire Effect', 
      description: 'Efek api dengan partikel merah-oranye',
      icon: 'üî•',
      color: '#ff4400',
      unlocked: false
    },
    { 
      id: 'ice', 
      name: 'Ice Effect', 
      description: 'Efek es dengan partikel biru',
      icon: '‚ùÑÔ∏è',
      color: '#00aaff',
      unlocked: false
    },
    { 
      id: 'poison', 
      name: 'Poison Effect', 
      description: 'Efek racun dengan partikel ungu',
      icon: '‚ò†Ô∏è',
      color: '#aa00ff',
      unlocked: false
    },
    { 
      id: 'nature', 
      name: 'Nature Effect', 
      description: 'Efek alam dengan partikel hijau',
      icon: 'üåø',
      color: '#00aa00',
      unlocked: false
    }
  ];
  
  // Game variables
  let snake=[];
  let dir={x:1,y:0};
  let nextDir={...dir};
  let food=null;
  let running=false;
  let score=0;
  let ticker=null;
  
  // Audio context
  let audioContext = null;
  let countdownTimer = null;
  let particleInterval = null;
  
  // ==================== UTILITY FUNCTIONS ====================
  
  // Hide all menus function
  function hideAllMenus() {
    MAIN_MENU.style.display = 'none';
    SETTINGS_MENU.style.display = 'none';
    FASHION_MENU.style.display = 'none';
    SKIN_MENU.style.display = 'none';
    GACHA_MENU.style.display = 'none';
    GAME_SCREEN.style.display = 'none';
    MULTIPLAYER_MENU.style.display = 'none';
    ROOM_LOBBY.style.display = 'none';
    COMING_SOON.style.display = 'none';
    GAME_STARTING_OVERLAY.style.display = 'none';
  }
  
  // Play button sound
  function playButtonSound() {
    if (effectOn && buttonSfx) {
      buttonSfx.currentTime = 0;
      buttonSfx.play().catch(e => console.log('Button SFX play failed:', e));
    }
  }
  
  // Play arrow button sound
  function playArrowButtonSound() {
    if (effectOn && arrowButtonSfx) {
      arrowButtonSfx.currentTime = 0;
      arrowButtonSfx.play().catch(e => console.log('Arrow Button SFX play failed:', e));
    }
  }
  
  // Render currency
  function renderCurrency() {
    MENU_COINS.textContent = coins;
    MENU_DIAMONDS.textContent = diamonds;
    GAME_COINS.textContent = coins;
    
    if (ONE_SPIN) ONE_SPIN.disabled = coins < 10;
    if (FIVE_SPIN) FIVE_SPIN.disabled = coins < 50;
  }
  
  // Save to localStorage
  function saveToStorage(key, value) {
    try {
      localStorage.setItem('snake_' + key, value);
    } catch (e) {
      console.log('Error saving to localStorage:', e);
    }
  }
  
  // Get from localStorage
  function getFromStorage(key, defaultValue) {
    try {
      const value = localStorage.getItem('snake_' + key);
      return value !== null ? value : defaultValue;
    } catch (e) {
      console.log('Error reading from localStorage:', e);
      return defaultValue;
    }
  }
  
  // Format time (seconds to MM:SS)
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
  
  // ==================== FIREBASE INITIALIZATION ====================
  
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC3Yw5NIexJddefw-AtutQ1vPhErdfL89s",
    authDomain: "akun-7b590.firebaseapp.com",
    databaseURL: "https://akun-7b590-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "akun-7b590",
    storageBucket: "akun-7b590.firebasestorage.app",
    messagingSenderId: "65784994154",
    appId: "1:65784994154:web:f7b9fd921736462985ed13",
    measurementId: "G-31JW6E46L1"
  };
  
  // Initialize Firebase
  function initializeFirebase() {
    console.log("Initializing Firebase...");
    
    try {
      // Check if Firebase SDK is loaded
      if (typeof firebase === 'undefined') {
        throw new Error('Firebase SDK tidak terdeteksi. Periksa koneksi internet Anda.');
      }
      
      // Check if Firebase app already exists
      if (!firebase.apps.length) {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        console.log("‚úÖ Firebase app initialized");
      } else {
        firebaseApp = firebase.app();
        console.log("‚úÖ Firebase app already initialized");
      }
      
      // Get database instance
      firebaseDatabase = firebase.database();
      console.log("‚úÖ Firebase Database initialized");
      
      // Update status indicator
      if (FIREBASE_STATUS) {
        FIREBASE_STATUS.textContent = "Connecting to Firebase...";
        FIREBASE_STATUS.className = "firebase-status";
      }
      
      // Test connection
      testFirebaseConnection();
      
    } catch (error) {
      console.error("‚ùå Firebase initialization error:", error);
      
      if (FIREBASE_STATUS) {
        FIREBASE_STATUS.textContent = "Firebase Error: " + error.message;
        FIREBASE_STATUS.className = "firebase-status disconnected";
      }
      
      // Disable multiplayer button if Firebase fails
      if (MULTIPLAYER_BTN) {
        MULTIPLAYER_BTN.disabled = true;
        MULTIPLAYER_BTN.innerHTML = "MULTIPLAYER (OFFLINE)";
        MULTIPLAYER_BTN.style.opacity = "0.5";
      }
      
      isFirebaseConnected = false;
    }
  }
  
  // Test Firebase connection
  function testFirebaseConnection() {
    if (!firebaseDatabase) return;
    
    const connectedRef = firebaseDatabase.ref('.info/connected');
    
    connectedRef.on('value', (snapshot) => {
      isFirebaseConnected = snapshot.val() === true;
      
      if (FIREBASE_STATUS) {
        if (isFirebaseConnected) {
          FIREBASE_STATUS.textContent = "‚úÖ Firebase Connected";
          FIREBASE_STATUS.className = "firebase-status connected";
          
          // Enable multiplayer button
          if (MULTIPLAYER_BTN) {
            MULTIPLAYER_BTN.disabled = false;
            MULTIPLAYER_BTN.innerHTML = "MULTIPLAYER";
            MULTIPLAYER_BTN.style.opacity = "1";
          }
        } else {
          FIREBASE_STATUS.textContent = "‚ùå Firebase Disconnected";
          FIREBASE_STATUS.className = "firebase-status disconnected";
        }
      }
      
      console.log(isFirebaseConnected ? "‚úÖ Firebase CONNECTED" : "‚ùå Firebase DISCONNECTED");
      
      // Update multiplayer stats if connected
      if (isFirebaseConnected) {
        updateMultiplayerStats();
      }
    });
  }
  
  // ==================== INITIAL SETUP ====================
  
  // Apply settings
  musicToggle.checked = musicOn;
  effectToggle.checked = effectOn;
  speedValEl.textContent = speed;
  
  // Initialize audio
  function initAudio() {
    if (audioContext) return;
    
    try {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      
      document.addEventListener('click', function initAudioOnce() {
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
        document.removeEventListener('click', initAudioOnce);
      });
      
      if (bgMusic) bgMusic.volume = 0.7;
      if (eatSfx) eatSfx.volume = 0.5;
      if (gameOverSfx) gameOverSfx.volume = 0.6;
      if (buttonSfx) buttonSfx.volume = 0.4;
      if (arrowButtonSfx) arrowButtonSfx.volume = 0.4;
      if (gachaWinSfx) gachaWinSfx.volume = 0.6;
      if (gachaZonkSfx) gachaZonkSfx.volume = 0.6;
      if (gachaSpinSfx) gachaSpinSfx.volume = 0.5;
      
      if (musicOn && bgMusic) {
        bgMusic.play().catch(e => console.log('Audio play failed:', e));
      }
    } catch (e) {
      console.log('Audio context not supported:', e);
    }
  }
  
  // ==================== SINGLE PLAYER GAME ====================
  
  function buildBoard(){
    BOARD.innerHTML='';
    BOARD.appendChild(GAMEOVER);
    cells=[];
    for(let i=0;i<gridSize;i++){
      const d=document.createElement('div');
      d.className='cell';
      BOARD.appendChild(d);
      cells.push(d);
    }
  }
  
  function idx(x,y){return y*cols+x;}
  function coord(i){return {x:i%cols,y:Math.floor(i/cols)};}
  function inside(x,y){return x>=0&&y>=0&&x<cols&&y<rows;}
  
  function placeFood(){
    let empty=[];
    for(let i=0;i<gridSize;i++) if(!snake.includes(i)) empty.push(i);
    if(empty.length===0) return null;
    food=empty[Math.floor(Math.random()*empty.length)];
  }
  
  function coinAnimation(x,y){
    const c = document.createElement('div');
    c.className='coinAnim';
    c.textContent='1ü™ô';
    c.style.left = (x*parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-size')))+'px';
    c.style.top = (y*parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-size')))+'px';
    BOARD.appendChild(c);
    setTimeout(()=>BOARD.removeChild(c),800);
  }
  
  function createParticle(x, y, effectType) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    
    const size = 6 + Math.random() * 6;
    particle.style.width = size + 'px';
    particle.style.height = size + 'px';
    
    switch(effectType) {
      case 'fire':
        particle.style.background = 'radial-gradient(circle, #ff9900, #ff4400)';
        particle.style.borderRadius = '50% 50% 20% 80%';
        particle.style.boxShadow = '0 0 4px #ff4400';
        break;
      case 'ice':
        particle.style.background = 'radial-gradient(circle, #00ffff, #00aaff)';
        particle.style.borderRadius = '60% 40% 30% 70%';
        particle.style.boxShadow = '0 0 3px #00aaff';
        break;
      case 'poison':
        particle.style.background = 'radial-gradient(circle, #ff00ff, #aa00ff)';
        particle.style.borderRadius = '50% 20% 80% 30%';
        particle.style.boxShadow = '0 0 3px #aa00ff';
        break;
      case 'nature':
        particle.style.background = 'radial-gradient(circle, #00ff00, #00aa00)';
        particle.style.borderRadius = '70% 30% 50% 50%';
        particle.style.boxShadow = '0 0 3px #00aa00';
        particle.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
        break;
      default:
        particle.style.background = 'radial-gradient(circle, #ffffff, #cccccc)';
        particle.style.borderRadius = '50%';
    }
    
    particle.style.left = (x * parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-size')) + Math.random() * 12 - 6) + 'px';
    particle.style.top = (y * parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-size')) + Math.random() * 12 - 6) + 'px';
    BOARD.appendChild(particle);
    
    setTimeout(() => {
      if (particle.parentNode) {
        particle.parentNode.removeChild(particle);
      }
    }, 1500);
  }
  
  function startParticleEffect() {
    if (particleInterval) clearInterval(particleInterval);
    
    if (currentEffect === 'default') return;
    
    particleInterval = setInterval(() => {
      if (!running) return;
      
      const head = coord(snake[snake.length-1]);
      for (let i = 0; i < 2; i++) {
        createParticle(head.x, head.y, currentEffect);
      }
    }, 300);
  }
  
  function render(){
    cells.forEach(c=>{c.className='cell';c.textContent='';c.style.backgroundImage='';});
    
    let snakeClass = 'snake';
    if (currentEffect !== 'default') {
      snakeClass += ' ' + currentEffect + '-effect';
    }
    
    if (customSkin) {
      snakeClass += ' custom-skin';
    }
    
    for(let i=0;i<snake.length;i++){
      let cl = snakeClass;
      if(i===snake.length-1) cl+=' head';
      cells[snake[i]].className='cell '+cl;
      
      if (customSkin && i === snake.length-1) {
        cells[snake[i]].style.backgroundImage = `url(${customSkin})`;
        cells[snake[i]].style.backgroundSize = 'cover';
        cells[snake[i]].style.backgroundPosition = 'center';
      }
    }
    
    if(food!==null){
      cells[food].className='cell food';
      cells[food].textContent='üçÜ';
    }
    
    SCORE.textContent=score;
    CURRENT_EFFECT.textContent = 'Efek: ' + effects.find(e => e.id === currentEffect).name;
    ACTIVE_EFFECT_NAME.textContent = effects.find(e => e.id === currentEffect).name;
    renderCurrency();
  }
  
  function step(){
    if(nextDir.x!==-dir.x||nextDir.y!==-dir.y) dir={...nextDir};
    const head=coord(snake[snake.length-1]);
    const nx=head.x+dir.x;
    const ny=head.y+dir.y;
    if(!inside(nx,ny)){ gameOver(); return;}
    const ni=idx(nx,ny);
    
    if(ni===food){
      snake.push(ni);
      score+=10;
      coins += 1;
      saveToStorage('coins', coins);
      coinAnimation(nx, ny);
      if(effectOn && eatSfx) {
        eatSfx.currentTime=0;
        eatSfx.play().catch(e => console.log('SFX play failed:', e));
      }
      placeFood();
    } else {
      snake.push(ni);
      snake.shift();
    }
    render();
  }
  
  function backToLobby() {
    hideAllMenus();
    MAIN_MENU.style.display = 'block';
    
    running = false;
    clearInterval(ticker);
    if (particleInterval) clearInterval(particleInterval);
    if (gameTimerInterval) clearInterval(gameTimerInterval);
    
    renderCurrency();
    
    // Reset multiplayer game state
    multiplayerPlayers = {};
    gameStartTime = null;
  }
  
  function startCountdown() {
    let count = 5;
    COUNTDOWN.textContent = `Kembali ke lobby dalam: ${count}`;
    
    countdownTimer = setInterval(() => {
      count--;
      COUNTDOWN.textContent = `Kembali ke lobby dalam: ${count}`;
      
      if (count <= 0) {
        clearInterval(countdownTimer);
        backToLobby();
      }
    }, 1000);
  }
  
  function gameOver(){
    running=false;
    clearInterval(ticker);
    if (particleInterval) clearInterval(particleInterval);
    
    if(effectOn && gameOverSfx) {
      gameOverSfx.currentTime=0;
      gameOverSfx.play().catch(e => console.log('Game over SFX play failed:', e));
    }
    
    GAMEOVER.style.display='flex';
    
    startCountdown();
  }
  
  function startGame(){
    if (countdownTimer) {
      clearInterval(countdownTimer);
      countdownTimer = null;
    }
    
    cols=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cols'))||cols;
    rows=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--rows'))||rows;
    gridSize=cols*rows;
    buildBoard();
    
    snake=[idx(Math.floor(cols/2),Math.floor(rows/2))];
    dir={x:1,y:0};
    nextDir={...dir};
    score=0;
    placeFood();
    render();
    running=true;
    GAMEOVER.style.display='none';
    clearInterval(ticker);
    ticker=setInterval(step,speed);
    
    startParticleEffect();
    
    initAudio();
  }
  
  // ==================== MULTIPLAYER FUNCTIONS ====================
  
  // Multiplayer helper functions
  function generateRoomCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }
  
  function generatePlayerId() {
    return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }
  
  function getRandomColor() {
    const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FF8800', '#8800FF'];
    return colors[Math.floor(Math.random() * colors.length)];
  }
  
  async function createRoom() {
    // Check Firebase connection
    if (!firebaseDatabase || !isFirebaseConnected) {
      alert("Firebase tidak terhubung. Periksa koneksi internet Anda atau refresh halaman.");
      
      // Try to reinitialize Firebase
      try {
        initializeFirebase();
        
        // Wait a bit for connection
        setTimeout(() => {
          if (isFirebaseConnected) {
            createRoom(); // Retry
          } else {
            alert("Gagal menghubungkan ke Firebase. Mode multiplayer tidak tersedia.");
          }
        }, 2000);
        
        return;
      } catch (error) {
        alert("Gagal menginisialisasi Firebase. Error: " + error.message);
        return;
      }
    }
    
    const roomCode = generateRoomCode();
    multiplayer.roomId = roomCode;
    multiplayer.playerId = generatePlayerId();
    multiplayer.isHost = true;
    multiplayer.playerColor = getRandomColor();
    
    hideAllMenus();
    ROOM_LOBBY.style.display = 'block';
    LOBBY_ROOM_CODE.textContent = roomCode;
    LOBBY_STATUS.textContent = "Menunggu pemain...";
    
    try {
      // Test write untuk memastikan database bisa diakses
      const testRef = firebaseDatabase.ref('test');
      await testRef.set({ test: Date.now() });
      await testRef.remove();
      
      // Buat room
      await firebaseDatabase.ref(`rooms/${roomCode}`).set({
        roomCode: roomCode,
        status: 'waiting',
        createdAt: Date.now(),
        maxPlayers: 8,
        currentPlayers: 1,
        hostId: multiplayer.playerId,
        players: {
          [multiplayer.playerId]: {
            id: multiplayer.playerId,
            name: multiplayer.playerName,
            isReady: true,
            isHost: true,
            color: multiplayer.playerColor
          }
        },
        settings: {
          mapShrink: document.getElementById('mapShrink') ? document.getElementById('mapShrink').checked : true,
          powerUps: document.getElementById('powerUps') ? document.getElementById('powerUps').checked : true,
          gameTime: document.getElementById('gameTime') ? parseInt(document.getElementById('gameTime').value) : 300
        }
      });
      
      listenToRoom(roomCode);
      
      updatePlayerList([{
        id: multiplayer.playerId,
        name: `${multiplayer.playerName} (You)`,
        isReady: true,
        isHost: true,
        color: multiplayer.playerColor
      }]);
      
      if (START_GAME_BTN) {
        START_GAME_BTN.disabled = false;
        START_GAME_BTN.textContent = "üöÄ START GAME";
      }
      
      console.log(`‚úÖ Room created: ${roomCode}`);
      
      // Update stats
      updateMultiplayerStats();
      
    } catch (error) {
      console.error("‚ùå Error creating room:", error);
      
      // Beri pesan error yang lebih spesifik
      let errorMessage = "Gagal membuat room.";
      
      if (error.code === 'PERMISSION_DENIED') {
        errorMessage = "Akses ditolak. Periksa aturan database Firebase Anda.";
      } else if (error.message.includes('network') || error.message.includes('offline')) {
        errorMessage = "Error jaringan. Periksa koneksi internet Anda.";
      } else {
        errorMessage = "Error: " + error.message;
      }
      
      alert(errorMessage);
      
      // Kembali ke menu
      hideAllMenus();
      MAIN_MENU.style.display = 'block';
    }
  }
  
  async function joinRoom(roomCode) {
    // Check Firebase connection
    if (!firebaseDatabase || !isFirebaseConnected) {
      alert("Firebase tidak terhubung. Periksa koneksi internet Anda.");
      return;
    }
    
    try {
      const snapshot = await firebaseDatabase.ref(`rooms/${roomCode}`).get();
      
      if (!snapshot.exists()) {
        alert("Room tidak ditemukan!");
        return;
      }
      
      const room = snapshot.val();
      if (room.status !== 'waiting') {
        alert("Game sudah dimulai!");
        return;
      }
      
      if (room.currentPlayers >= room.maxPlayers) {
        alert("Room sudah penuh!");
        return;
      }
      
      multiplayer.roomId = roomCode;
      multiplayer.playerId = generatePlayerId();
      multiplayer.isHost = false;
      multiplayer.playerColor = getRandomColor();
      
      hideAllMenus();
      ROOM_LOBBY.style.display = 'block';
      LOBBY_ROOM_CODE.textContent = roomCode;
      LOBBY_STATUS.textContent = "Menunggu host...";
      
      await firebaseDatabase.ref(`rooms/${roomCode}/players/${multiplayer.playerId}`).set({
        id: multiplayer.playerId,
        name: multiplayer.playerName,
        isReady: true,
        isHost: false,
        color: multiplayer.playerColor
      });
      
      await firebaseDatabase.ref(`rooms/${roomCode}`).update({
        currentPlayers: room.currentPlayers + 1
      });
      
      listenToRoom(roomCode);
      
    } catch (error) {
      console.error("Error joining room:", error);
      alert("Gagal join room. Error: " + error.message);
      hideAllMenus();
      MAIN_MENU.style.display = 'block';
    }
  }
  
  function listenToRoom(roomCode) {
    if (!firebaseDatabase) return;
    
    // Remove existing listener if any
    if (roomListener) {
      firebaseDatabase.ref(`rooms/${roomCode}`).off('value', roomListener);
    }
    
    roomListener = (snapshot) => {
      const room = snapshot.val();
      if (!room) {
        // Room deleted
        if (LOBBY_STATUS) LOBBY_STATUS.textContent = "Room telah dihapus";
        setTimeout(() => {
          leaveRoom();
          hideAllMenus();
          MAIN_MENU.style.display = 'block';
          alert("Room telah dihapus oleh host.");
        }, 2000);
        return;
      }
      
      // Update lobby UI
      if (LOBBY_STATUS) {
        if (room.status === 'waiting') {
          LOBBY_STATUS.textContent = `Menunggu pemain... (${room.currentPlayers}/${room.maxPlayers})`;
        } else if (room.status === 'starting') {
          const countdown = room.gameData?.countdown || 3;
          LOBBY_STATUS.textContent = `Game mulai dalam ${countdown}...`;
          
          // Show countdown for all players
          ROOM_COUNTDOWN.style.display = 'block';
          ROOM_COUNTDOWN.textContent = countdown;
          
          // Start countdown animation
          startRoomCountdown(countdown);
        } else if (room.status === 'playing') {
          LOBBY_STATUS.textContent = "Game sedang berjalan...";
          // Auto-join game if not already in game
          if (GAME_SCREEN.style.display === 'none') {
            startMultiplayerGame(room);
          }
        }
      }
      
      if (LOBBY_PLAYER_COUNT) {
        LOBBY_PLAYER_COUNT.textContent = `${room.currentPlayers}/${room.maxPlayers}`;
      }
      
      // Update player list
      if (room.players) {
        const players = Object.values(room.players);
        updatePlayerList(players);
        
        // Store players for game
        multiplayerPlayers = {};
        players.forEach(player => {
          multiplayerPlayers[player.id] = player;
        });
        
        // Enable start button if host and enough players
        if (START_GAME_BTN) {
          const isHost = multiplayer.isHost;
          const hasEnoughPlayers = room.currentPlayers >= 2;
          
          START_GAME_BTN.disabled = !isHost || !hasEnoughPlayers;
          
          if (!isHost) {
            START_GAME_BTN.title = "Hanya host yang bisa memulai game";
          } else if (!hasEnoughPlayers) {
            START_GAME_BTN.title = "Minimal 2 pemain diperlukan";
          } else {
            START_GAME_BTN.title = "Klik untuk memulai game";
          }
        }
      }
      
      // Handle game countdown
      if (room.status === 'starting' && room.gameData?.countdown) {
        // Countdown is handled by the host's UI
      }
      
      // Auto-start game if host started it
      if (room.status === 'playing' && !multiplayer.isHost) {
        startMultiplayerGame(room);
      }
    };
    
    firebaseDatabase.ref(`rooms/${roomCode}`).on('value', roomListener);
  }
  
  function startRoomCountdown(countdown) {
    let remaining = countdown;
    const countdownInterval = setInterval(() => {
      remaining--;
      if (ROOM_COUNTDOWN) {
        ROOM_COUNTDOWN.textContent = remaining;
      }
      
      if (remaining <= 0) {
        clearInterval(countdownInterval);
        ROOM_COUNTDOWN.style.display = 'none';
      }
    }, 1000);
  }
  
  function updatePlayerList(players) {
    if (!LOBBY_PLAYER_LIST) return;
    
    LOBBY_PLAYER_LIST.innerHTML = '';
    
    players.forEach(player => {
      const isMe = player.id === multiplayer.playerId;
      
      const playerElement = document.createElement('div');
      playerElement.className = 'player-item';
      playerElement.style.borderLeft = `4px solid ${player.color || getRandomColor()}`;
      
      playerElement.innerHTML = `
        <div class="player-color" style="background:${player.color || getRandomColor()}"></div>
        <div class="player-name" style="color:${isMe ? '#ffd60a' : '#fff'}">${player.name} ${isMe ? '(You)' : ''}</div>
        <div class="player-ready">${player.isHost ? 'üëë Host' : (player.isReady ? '‚úÖ Ready' : '‚ùå Not Ready')}</div>
      `;
      
      LOBBY_PLAYER_LIST.appendChild(playerElement);
    });
    
    // Update START_GAME_BTN based on player count
    if (START_GAME_BTN && multiplayer.isHost) {
      const hasEnoughPlayers = players.length >= 2;
      START_GAME_BTN.disabled = !hasEnoughPlayers;
      
      if (!hasEnoughPlayers) {
        START_GAME_BTN.title = `Perlu ${2 - players.length} pemain lagi`;
      } else {
        START_GAME_BTN.title = "Mulai game!";
      }
    }
  }
  
  async function startMultiplayerGame(roomData) {
    // Show game starting overlay
    GAME_STARTING_OVERLAY.style.display = 'flex';
    
    // Start countdown for all players
    let countdown = 3;
    START_COUNTDOWN.textContent = countdown;
    
    const countdownInterval = setInterval(() => {
      countdown--;
      START_COUNTDOWN.textContent = countdown;
      
      if (countdown <= 0) {
        clearInterval(countdownInterval);
        GAME_STARTING_OVERLAY.style.display = 'none';
        
        // Hide lobby and show game screen
        ROOM_LOBBY.style.display = 'none';
        
        // Start the multiplayer game session
        startMultiplayerGameSession(roomData);
      }
    }, 1000);
  }
  
  function startMultiplayerGameSession(roomData) {
    // Set up multiplayer game screen
    hideAllMenus();
    GAME_SCREEN.style.display = 'block';
    MULTIPLAYER_HUD.style.display = 'flex';
    
    // Show back to lobby button
    if (BACK_TO_LOBBY) {
      BACK_TO_LOBBY.style.display = 'block';
    }
    
    // Update title for multiplayer
    const titleElement = document.querySelector('.title');
    if (titleElement) {
      titleElement.textContent = `MULTIPLAYER - Room: ${roomData.roomCode}`;
    }
    
    // Add multiplayer info
    const smallInfo = document.querySelector('.small');
    if (smallInfo) {
      smallInfo.innerHTML = `Players: ${roomData.currentPlayers}/${roomData.maxPlayers} | Room: ${roomData.roomCode}`;
    }
    
    // Initialize multiplayer game variables
    cols = 18; // Larger board for multiplayer
    rows = 14;
    gridSize = cols * rows;
    gameDuration = roomData.settings?.gameTime || 300;
    
    // Reset and start game
    buildBoard();
    
    // Set initial snake position
    snake = [idx(Math.floor(cols/2), Math.floor(rows/2))];
    dir = {x:1,y:0};
    nextDir = {...dir};
    score = 0;
    placeFood();
    render();
    running = true;
    GAMEOVER.style.display = 'none';
    
    // Clear existing interval
    clearInterval(ticker);
    
    // Start game loop
    ticker = setInterval(step, speed);
    
    // Start particle effects
    startParticleEffect();
    
    // Start multiplayer HUD
    updateMultiplayerHUD(roomData);
    
    // Start game timer
    startGameTimer();
    
    initAudio();
  }
  
  function updateMultiplayerHUD(roomData) {
    if (!PLAYER_LIST_MINI) return;
    
    PLAYER_LIST_MINI.innerHTML = '';
    
    // Add current player
    const currentPlayer = {
      id: multiplayer.playerId,
      name: 'You',
      color: multiplayer.playerColor,
      score: score
    };
    
    const playerElement = document.createElement('div');
    playerElement.className = 'mini-player';
    playerElement.innerHTML = `
      <div class="mini-color" style="background:${currentPlayer.color}"></div>
      <span>${currentPlayer.name}: ${currentPlayer.score}</span>
    `;
    PLAYER_LIST_MINI.appendChild(playerElement);
    
    // Add other players (in real implementation, this would be synced via Firebase)
    Object.values(multiplayerPlayers).forEach(player => {
      if (player.id !== multiplayer.playerId) {
        const otherPlayerElement = document.createElement('div');
        otherPlayerElement.className = 'mini-player';
        otherPlayerElement.innerHTML = `
          <div class="mini-color" style="background:${player.color}"></div>
          <span>${player.name}: 0</span>
        `;
        PLAYER_LIST_MINI.appendChild(otherPlayerElement);
      }
    });
  }
  
  function startGameTimer() {
    gameStartTime = Date.now();
    let remainingTime = gameDuration;
    
    if (GAME_TIMER) {
      GAME_TIMER.textContent = formatTime(remainingTime);
    }
    
    gameTimerInterval = setInterval(() => {
      const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
      remainingTime = Math.max(0, gameDuration - elapsed);
      
      if (GAME_TIMER) {
        GAME_TIMER.textContent = formatTime(remainingTime);
      }
      
      if (remainingTime <= 0) {
        clearInterval(gameTimerInterval);
        endMultiplayerGame();
      }
    }, 1000);
  }
  
  function endMultiplayerGame() {
    running = false;
    clearInterval(ticker);
    clearInterval(gameTimerInterval);
    
    // Show game over screen for multiplayer
    if (GAMEOVER) {
      GAMEOVER.style.display = 'flex';
      const gameoverText = GAMEOVER.querySelector('.gameover-text');
      if (gameoverText) {
        gameoverText.textContent = `Game Over! Score: ${score}`;
      }
    }
    
    // After 5 seconds, go back to lobby
    setTimeout(() => {
      leaveRoom();
      hideAllMenus();
      MAIN_MENU.style.display = 'block';
      alert(`Game selesai! Skor akhir: ${score}`);
    }, 5000);
  }
  
  async function leaveRoom() {
    if (!multiplayer.roomId || !multiplayer.playerId || !firebaseDatabase) {
      hideAllMenus();
      MAIN_MENU.style.display = 'block';
      return;
    }
    
    try {
      // Remove player from room
      await firebaseDatabase.ref(`rooms/${multiplayer.roomId}/players/${multiplayer.playerId}`).remove();
      
      // Decrease player count
      const roomRef = firebaseDatabase.ref(`rooms/${multiplayer.roomId}`);
      const snapshot = await roomRef.get();
      
      if (snapshot.exists()) {
        const room = snapshot.val();
        await roomRef.update({
          currentPlayers: room.currentPlayers - 1
        });
        
        // If no players left, delete room
        if (room.currentPlayers <= 1) {
          await roomRef.remove();
        }
      }
      
    } catch (error) {
      console.error("Error leaving room:", error);
    }
    
    // Reset multiplayer state
    multiplayer = {
      roomId: null,
      playerId: null,
      playerName: `Player${Math.floor(Math.random() * 1000)}`,
      isHost: false,
      gameLoop: null,
      playerColor: '#00ffa1'
    };
    
    multiplayerPlayers = {};
    
    // Clear intervals
    if (gameTimerInterval) clearInterval(gameTimerInterval);
  }
  
  function updateMultiplayerStats() {
    if (!firebaseDatabase || !isFirebaseConnected) {
      if (FIREBASE_STATUS) {
        FIREBASE_STATUS.textContent = "‚ùå Firebase Disconnected";
        FIREBASE_STATUS.className = "firebase-status disconnected";
      }
      return;
    }
    
    firebaseDatabase.ref('rooms').once('value').then(snapshot => {
      let totalPlayers = 0;
      let activeRooms = 0;
      
      if (snapshot.exists()) {
        const rooms = snapshot.val();
        activeRooms = Object.keys(rooms).length;
        
        Object.values(rooms).forEach(room => {
          totalPlayers += room.currentPlayers || 0;
        });
      }
      
      const onlinePlayersEl = document.getElementById('onlinePlayers');
      const activeRoomsEl = document.getElementById('activeRooms');
      
      if (onlinePlayersEl) onlinePlayersEl.textContent = totalPlayers;
      if (activeRoomsEl) activeRoomsEl.textContent = activeRooms;
      
      // Update status indicator
      if (FIREBASE_STATUS) {
        FIREBASE_STATUS.textContent = `‚úÖ Connected: ${activeRooms} rooms, ${totalPlayers} players`;
        FIREBASE_STATUS.className = "firebase-status connected";
      }
    }).catch(error => {
      console.error("Error getting multiplayer stats:", error);
      
      if (FIREBASE_STATUS) {
        FIREBASE_STATUS.textContent = "‚ùå Error loading stats";
        FIREBASE_STATUS.className = "firebase-status disconnected";
      }
    });
  }
  
  // ==================== OTHER GAME FEATURES ====================
  
  // [Kode untuk Fashion Menu, Skin Editor, Gacha System tetap sama seperti sebelumnya]
  // Karena panjang kode, saya potong bagian ini untuk fokus pada multiplayer
  
  // ==================== EVENT LISTENERS ====================
  
  // Initialize event listeners
  function initEventListeners() {
    // Main Menu buttons
    if (PLAY_BTN) {
      PLAY_BTN.addEventListener('click', function() {
        playButtonSound();
        hideAllMenus();
        GAME_SCREEN.style.display = 'block';
        startGame();
      });
    }
    
    if (MENU_SETTINGS_BTN) {
      MENU_SETTINGS_BTN.addEventListener('click', function() {
        playButtonSound();
        hideAllMenus();
        SETTINGS_MENU.style.display = 'block';
        initAudio();
      });
    }
    
    if (FASHION_BTN) {
      FASHION_BTN.addEventListener('click', function() {
        playButtonSound();
        hideAllMenus();
        FASHION_MENU.style.display = 'block';
        initAudio();
      });
    }
    
    if (SKIN_BTN) {
      SKIN_BTN.addEventListener('click', function() {
        playButtonSound();
        hideAllMenus();
        SKIN_MENU.style.display = 'block';
        initAudio();
      });
    }
    
    if (GACHA_BTN) {
      GACHA_BTN.addEventListener('click', function() {
        playButtonSound();
        hideAllMenus();
        GACHA_MENU.style.display = 'block';
        initGacha();
        renderCurrency();
        initAudio();
      });
    }
    
    if (MULTIPLAYER_BTN) {
      MULTIPLAYER_BTN.addEventListener('click', function() {
        playButtonSound();
        hideAllMenus();
        MULTIPLAYER_MENU.style.display = 'block';
        updateMultiplayerStats();
      });
    }
    
    // Back buttons
    if (SETTINGS_BACK_BTN) {
      SETTINGS_BACK_BTN.addEventListener('click', function() {
        playButtonSound();
        hideAllMenus();
        MAIN_MENU.style.display = 'block';
      });
    }
    
    if (FASHION_BACK_BTN) {
      FASHION_BACK_BTN.addEventListener('click', function() {
        playButtonSound();
        hideAllMenus();
        MAIN_MENU.style.display = 'block';
      });
    }
    
    if (SKIN_BACK_BTN) {
      SKIN_BACK_BTN.addEventListener('click', function() {
        playButtonSound();
        hideAllMenus();
        MAIN_MENU.style.display = 'block';
      });
    }
    
    if (GACHA_BACK_BTN) {
      GACHA_BACK_BTN.addEventListener('click', function() {
        playButtonSound();
        hideAllMenus();
        MAIN_MENU.style.display = 'block';
      });
    }
    
    if (MULTIPLAYER_BACK_BTN) {
      MULTIPLAYER_BACK_BTN.addEventListener('click', function() {
        playButtonSound();
        leaveRoom();
        hideAllMenus();
        MAIN_MENU.style.display = 'block';
      });
    }
    
    // Multiplayer buttons
    if (CREATE_ROOM_BTN) {
      CREATE_ROOM_BTN.addEventListener('click', async function() {
        playButtonSound();
        await createRoom();
      });
    }
    
    if (JOIN_ROOM_BTN) {
      JOIN_ROOM_BTN.addEventListener('click', function() {
        playButtonSound();
        const roomCode = prompt("Masukkan Kode Room (6 karakter):");
        if (roomCode && roomCode.length === 6) {
          joinRoom(roomCode.toUpperCase());
        } else {
          alert("Masukkan kode room yang valid (6 karakter)!");
        }
      });
    }
    
    if (QUICK_PLAY_BTN) {
      QUICK_PLAY_BTN.addEventListener('click', function() {
        playButtonSound();
        alert("Quick Play akan segera hadir!\n\nUntuk sekarang, buat room dan bagikan kodenya ke teman!");
      });
    }
    
    if (MP_LEADERBOARD_BTN) {
      MP_LEADERBOARD_BTN.addEventListener('click', function() {
        playButtonSound();
        hideAllMenus();
        COMING_SOON.style.display = 'flex';
      });
    }
    
    // Lobby buttons
    if (COPY_LINK_BTN) {
      COPY_LINK_BTN.addEventListener('click', function() {
        const roomCode = LOBBY_ROOM_CODE.textContent;
        const inviteLink = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
        
        navigator.clipboard.writeText(inviteLink).then(() => {
          alert(`Link berhasil disalin!\n\nBagikan ini ke teman:\n${inviteLink}`);
        }).catch(err => {
          prompt("Copy link ini untuk dibagikan:", inviteLink);
        });
      });
    }
    
    if (START_GAME_BTN) {
      START_GAME_BTN.addEventListener('click', async function() {
        if (!multiplayer.isHost) {
          alert("Hanya host yang bisa memulai game!");
          return;
        }
        
        playButtonSound();
        
        try {
          // Get current room data first
          const snapshot = await firebaseDatabase.ref(`rooms/${multiplayer.roomId}`).get();
          if (!snapshot.exists()) {
            alert("Room tidak ditemukan!");
            return;
          }
          
          const roomData = snapshot.val();
          
          // Check if minimum players are present
          if (roomData.currentPlayers < 2) {
            alert("Minimal 2 pemain diperlukan untuk memulai game!");
            return;
          }
          
          // Update settings
          const mapShrink = document.getElementById('mapShrink') ? document.getElementById('mapShrink').checked : true;
          const powerUps = document.getElementById('powerUps') ? document.getElementById('powerUps').checked : true;
          const gameTime = document.getElementById('gameTime') ? parseInt(document.getElementById('gameTime').value) : 300;
          
          await firebaseDatabase.ref(`rooms/${multiplayer.roomId}/settings`).update({
            mapShrink,
            powerUps,
            gameTime
          });
          
          // Start countdown for all players
          await firebaseDatabase.ref(`rooms/${multiplayer.roomId}`).update({
            status: 'starting',
            'gameData.countdown': 3
          });
          
          // The countdown will be handled by listenToRoom()
          
        } catch (error) {
          console.error("Error starting game:", error);
          alert("Gagal memulai game: " + error.message);
        }
      });
    }
    
    if (LEAVE_LOBBY_BTN) {
      LEAVE_LOBBY_BTN.addEventListener('click', function() {
        playButtonSound();
        leaveRoom();
        hideAllMenus();
        MAIN_MENU.style.display = 'block';
      });
    }
    
    // Back to lobby button in game
    if (BACK_TO_LOBBY) {
      BACK_TO_LOBBY.addEventListener('click', function() {
        playButtonSound();
        leaveRoom();
        backToLobby();
      });
    }
    
    // [Kode event listeners lainnya tetap sama]
    
    // Keyboard controls
    document.addEventListener('keydown', function(e) {
      const key = e.key;
      if(key==='ArrowUp'||key==='w'||key==='W') nextDir={x:0,y:-1};
      if(key==='ArrowDown'||key==='s'||key==='S') nextDir={x:0,y:1};
      if(key==='ArrowLeft'||key==='a'||key==='A') nextDir={x:-1,y:0};
      if(key==='ArrowRight'||key==='d'||key==='D') nextDir={x:1,y:0};
      
      initAudio();
    });
    
    // [Kode kontrol lainnya tetap sama]
  }
  
  // ==================== INITIALIZATION ====================
  
  // Initialize the game
  function initGame() {
    // Initialize currency
    renderCurrency();
    
    // Initialize Firebase
    initializeFirebase();
    
    // Initialize event listeners
    initEventListeners();
    
    // Initialize board
    buildBoard();
    
    // Load room from URL
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room');
    
    if (roomCode && roomCode.length === 6) {
      // Auto-join room after Firebase is initialized
      setTimeout(() => {
        if (firebaseDatabase && isFirebaseConnected) {
          joinRoom(roomCode.toUpperCase());
        }
      }, 1000);
    } else {
      // Show main menu
      hideAllMenus();
      MAIN_MENU.style.display = 'block';
    }
    
    console.log("‚úÖ Game initialized successfully!");
  }
  
  // Start the game when page loads
  window.addEventListener('load', initGame);
  
})();
</script>
</body>
</html>
