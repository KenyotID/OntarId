<!DOCTYPE html>
<html>
<head>
    <title>Multiplayer Room Game</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <style>
        /* CSS untuk Lobby */
        .lobby-screen {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .lobby-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        .lobby-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .lobby-button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .lobby-button:hover {
            background: #45a049;
        }
        .divider {
            margin: 20px 0;
            color: #666;
        }
        .error-message {
            color: red;
            margin: 10px 0;
            display: none;
            background: #ffeaea;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid red;
        }
        .success-message {
            color: green;
            margin: 10px 0;
            display: none;
            background: #eaffea;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid green;
        }

        /* CSS untuk Game Screen */
        .game-screen {
            display: none;
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: white;
            font-family: Arial, sans-serif;
            min-height: 100vh;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #16213e;
            border-radius: 10px;
        }
        .game-area {
            position: relative;
            width: 800px;
            height: 500px;
            background: #0f3460;
            border: 3px solid #e94560;
            border-radius: 10px;
            margin: 0 auto;
            overflow: hidden;
        }
        .player {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px black;
            transition: all 0.3s ease;
            border: 2px solid white;
        }
        .player-name {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            white-space: nowrap;
            background: rgba(0,0,0,0.7);
            padding: 2px 6px;
            border-radius: 4px;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        .controls button {
            padding: 12px 20px;
            margin: 5px;
            font-size: 16px;
            background: #e94560;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .controls button:hover {
            background: #ff6b81;
        }
        .players-list {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #16213e;
            padding: 15px;
            border-radius: 10px;
            min-width: 200px;
        }
        .back-button {
            background: #666 !important;
        }
        .back-button:hover {
            background: #888 !important;
        }
        .loading {
            display: none;
            color: #4CAF50;
            margin: 10px 0;
        }
        .instructions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: left;
        }
    </style>
</head>
<body>
    <!-- Lobby Screen -->
    <div id="lobbyScreen" class="lobby-screen">
        <div class="lobby-container">
            <h1>üéÆ Multiplayer Game</h1>
            
            <div class="instructions">
                <strong>Sebelum main:</strong><br>
                1. Buka <a href="https://console.firebase.google.com/u/3/project/akun-7b590/database/akun-7b590-default-rtdb/rules" target="_blank">Firebase Rules</a><br>
                2. Ganti rules jadi:<br>
                <code style="font-size: 10px; background: #f5f5f5; padding: 5px; display: block;">
                { "rules": { ".read": true, ".write": true } }
                </code>
                3. Klik "Publish"
            </div>
            
            <input type="text" id="playerName" class="lobby-input" placeholder="Masukkan nama kamu" maxlength="15">
            
            <button onclick="createRoom()" class="lobby-button">üÜï Create Room</button>
            
            <div class="divider">atau</div>
            
            <input type="text" id="roomCode" class="lobby-input" placeholder="Masukkan kode room" maxlength="6">
            <button onclick="joinRoom()" class="lobby-button">üö™ Join Room</button>
            
            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>
            <div id="loadingMessage" class="loading">Loading...</div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="game-screen">
        <div class="header">
            <h1>üéÆ Room: <span id="roomCodeDisplay"></span></h1>
            <div>
                <span id="playerCount">Players: 0</span>
                <button onclick="leaveRoom()" class="controls back-button" style="margin-left: 15px;">‚Üê Keluar</button>
            </div>
        </div>

        <div class="controls">
            <button onclick="movePlayer(-30, 0)">‚¨Ö Kiri</button>
            <button onclick="movePlayer(30, 0)">Kanan ‚û°</button>
            <button onclick="movePlayer(0, -30)">‚¨Ü Atas</button>
            <button onclick="movePlayer(0, 30)">‚¨á Bawah</button>
            <button onclick="changeColor()">üé® Ganti Warna</button>
        </div>

        <div class="game-area" id="gameArea">
            <!-- Players akan muncul di sini -->
        </div>

        <div class="players-list" id="playersList">
            <h3>üë• Players in Room:</h3>
            <div id="playersInfo"></div>
        </div>
    </div>

    <script>
        // Firebase Config - FIXED dengan databaseURL
        const firebaseConfig = {
            apiKey: "AIzaSyC3Yw5NIexJddefw-AtutQ1vPhErdfL89s",
            authDomain: "akun-7b590.firebaseapp.com",
            databaseURL: "https://akun-7b590-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "akun-7b590",
            storageBucket: "akun-7b590.firebasestorage.app",
            messagingSenderId: "65784994154",
            appId: "1:65784994154:web:f7b9fd921736462985ed13"
        };

        // Global variables
        let db = null;
        let currentRoomCode = '';
        let currentPlayerId = '';
        let currentPlayerName = '';
        let currentPlayerData = {};

        // Initialize Firebase
        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                console.log('üî• Firebase initialized successfully');
                showSuccess('Connected to server!');
                return true;
            } catch (error) {
                console.error('‚ùå Firebase initialization error:', error);
                showError('Gagal connect ke server: ' + error.message);
                return false;
            }
        }

        // Fungsi untuk menampilkan error
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            const successDiv = document.getElementById('successMessage');
            successDiv.style.display = 'none';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Fungsi untuk menampilkan success
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.style.display = 'none';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Fungsi untuk menampilkan loading
        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
        }

        // Fungsi untuk generate room code
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Fungsi untuk beralih screen
        function showScreen(screen) {
            if (screen === 'lobby') {
                document.getElementById('lobbyScreen').style.display = 'flex';
                document.getElementById('gameScreen').style.display = 'none';
            } else {
                document.getElementById('lobbyScreen').style.display = 'none';
                document.getElementById('gameScreen').style.display = 'block';
            }
        }

        // Create Room
        function createRoom() {
            if (!db) {
                showError('Database belum terinisialisasi. Refresh halaman.');
                return;
            }

            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                showError('Masukkan nama dulu!');
                return;
            }

            showLoading(true);
            
            currentRoomCode = generateRoomCode();
            currentPlayerId = 'player_' + Math.random().toString(36).substr(2, 9);
            currentPlayerName = playerName;
            
            // Buat data player
            currentPlayerData = {
                name: playerName,
                x: 100,
                y: 100,
                color: '#' + Math.floor(Math.random()*16777215).toString(16),
                isHost: true,
                lastUpdate: Date.now()
            };

            console.log('üöÄ Creating room:', currentRoomCode);

            // Test write permission dulu
            db.ref('test').set({ test: Date.now() })
                .then(() => {
                    console.log('‚úÖ Write permission OK');
                    // Buat room baru
                    return db.ref('rooms/' + currentRoomCode).set({
                        created: Date.now(),
                        status: 'active',
                        host: currentPlayerId
                    });
                })
                .then(() => {
                    console.log('‚úÖ Room created');
                    // Tambah player ke room
                    return db.ref('rooms/' + currentRoomCode + '/players/' + currentPlayerId).set(currentPlayerData);
                })
                .then(() => {
                    console.log('‚úÖ Player added to room');
                    showLoading(false);
                    setupGameListener();
                    showGameScreen();
                    showSuccess('Room created: ' + currentRoomCode);
                })
                .catch((error) => {
                    console.error('‚ùå Error creating room:', error);
                    showLoading(false);
                    if (error.code === 'PERMISSION_DENIED') {
                        showError('PERMISSION_DENIED: Update Firebase Rules dulu! Buka: console.firebase.google.com ‚Üí Database ‚Üí Rules ‚Üí Ganti jadi: { "rules": { ".read": true, ".write": true } } ‚Üí Publish');
                    } else {
                        showError('Error membuat room: ' + error.message);
                    }
                });
        }

        // Join Room
        function joinRoom() {
            if (!db) {
                showError('Database belum terinisialisasi. Refresh halaman.');
                return;
            }

            const playerName = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
            
            if (!playerName) {
                showError('Masukkan nama dulu!');
                return;
            }
            
            if (!roomCode) {
                showError('Masukkan kode room!');
                return;
            }

            showLoading(true);
            console.log('üöÄ Joining room:', roomCode);

            // Cek apakah room exists
            db.ref('rooms/' + roomCode).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    currentRoomCode = roomCode;
                    currentPlayerId = 'player_' + Math.random().toString(36).substr(2, 9);
                    currentPlayerName = playerName;
                    
                    // Buat data player
                    currentPlayerData = {
                        name: playerName,
                        x: Math.floor(Math.random() * 600) + 100,
                        y: Math.floor(Math.random() * 300) + 100,
                        color: '#' + Math.floor(Math.random()*16777215).toString(16),
                        isHost: false,
                        lastUpdate: Date.now()
                    };

                    console.log('‚úÖ Adding player to room:', currentPlayerId);

                    // Join room
                    return db.ref('rooms/' + currentRoomCode + '/players/' + currentPlayerId).set(currentPlayerData);
                } else {
                    throw new Error('Room tidak ditemukan!');
                }
            }).then(() => {
                console.log('‚úÖ Joined room successfully');
                showLoading(false);
                setupGameListener();
                showGameScreen();
                showSuccess('Joined room: ' + currentRoomCode);
            }).catch((error) => {
                console.error('‚ùå Error joining room:', error);
                showLoading(false);
                if (error.code === 'PERMISSION_DENIED') {
                    showError('PERMISSION_DENIED: Update Firebase Rules dulu! Buka: console.firebase.google.com ‚Üí Database ‚Üí Rules ‚Üí Ganti jadi: { "rules": { ".read": true, ".write": true } } ‚Üí Publish');
                } else {
                    showError(error.message);
                }
            });
        }

        // Setup real-time listener untuk game
        function setupGameListener() {
            db.ref('rooms/' + currentRoomCode + '/players').on('value', (snapshot) => {
                const players = snapshot.val();
                console.log('üîÑ Players update:', players);
                updateGameDisplay(players);
            });
        }

        // Tampilkan game screen
        function showGameScreen() {
            document.getElementById('roomCodeDisplay').textContent = currentRoomCode;
            showScreen('game');
            console.log('üéÆ Game screen shown for room:', currentRoomCode);
        }

        // Update game display
        function updateGameDisplay(players) {
            const gameArea = document.getElementById('gameArea');
            const playersInfo = document.getElementById('playersInfo');
            
            // Clear existing players
            gameArea.innerHTML = '';
            playersInfo.innerHTML = '';

            if (!players) {
                playersInfo.innerHTML = '<p>No players in room</p>';
                document.getElementById('playerCount').textContent = 'Players: 0';
                return;
            }

            const playerCount = Object.keys(players).length;
            document.getElementById('playerCount').textContent = `Players: ${playerCount}`;

            // Render semua players
            for (let playerId in players) {
                const player = players[playerId];
                const isMe = playerId === currentPlayerId;

                // Tambah ke game area
                const playerElement = document.createElement('div');
                playerElement.className = 'player';
                playerElement.style.left = player.x + 'px';
                playerElement.style.top = player.y + 'px';
                playerElement.style.backgroundColor = player.color;
                playerElement.innerHTML = `
                    <div class="player-name">${player.name} ${isMe ? ' (YOU)' : ''}</div>
                    <div style="font-size: 10px;">${player.isHost ? 'üëë' : 'üë§'}</div>
                `;
                gameArea.appendChild(playerElement);

                // Tambah ke players list
                const playerInfo = document.createElement('div');
                playerInfo.style.margin = '5px 0';
                playerInfo.style.padding = '5px';
                playerInfo.style.background = isMe ? '#e94560' : 'transparent';
                playerInfo.style.borderRadius = '4px';
                playerInfo.innerHTML = `
                    ${player.isHost ? 'üëë' : 'üë§'} ${player.name} ${isMe ? ' (YOU)' : ''}
                `;
                playersInfo.appendChild(playerInfo);
            }
        }

        // Fungsi gerak player
        function movePlayer(dx, dy) {
            if (!currentRoomCode || !currentPlayerId || !db) return;
            
            currentPlayerData.x += dx;
            currentPlayerData.y += dy;
            currentPlayerData.lastUpdate = Date.now();
            
            // Pastikan tidak keluar dari batas
            currentPlayerData.x = Math.max(0, Math.min(760, currentPlayerData.x));
            currentPlayerData.y = Math.max(0, Math.min(460, currentPlayerData.y));
            
            db.ref('rooms/' + currentRoomCode + '/players/' + currentPlayerId).set(currentPlayerData)
                .catch(error => {
                    console.error('Error moving player:', error);
                    if (error.code === 'PERMISSION_DENIED') {
                        showError('Permission denied! Update Firebase Rules.');
                    }
                });
        }

        // Ganti warna player
        function changeColor() {
            if (!currentRoomCode || !currentPlayerId || !db) return;
            
            currentPlayerData.color = '#' + Math.floor(Math.random()*16777215).toString(16);
            currentPlayerData.lastUpdate = Date.now();
            db.ref('rooms/' + currentRoomCode + '/players/' + currentPlayerId).set(currentPlayerData)
                .catch(error => {
                    console.error('Error changing color:', error);
                });
        }

        // Keluar dari room
        function leaveRoom() {
            if (confirm('Keluar dari room?')) {
                // Hapus player dari room
                if (currentRoomCode && currentPlayerId && db) {
                    db.ref('rooms/' + currentRoomCode + '/players/' + currentPlayerId).remove()
                        .catch(error => console.error('Error leaving room:', error));
                }
                
                // Kembali ke lobby
                showScreen('lobby');
                
                // Reset form
                document.getElementById('playerName').value = '';
                document.getElementById('roomCode').value = '';
                
                // Reset variables
                currentRoomCode = '';
                currentPlayerId = '';
            }
        }

        // Event listeners untuk Enter key
        document.getElementById('playerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') createRoom();
        });
        
        document.getElementById('roomCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') joinRoom();
        });

        // Cleanup ketika tutup browser
        window.addEventListener('beforeunload', () => {
            if (currentRoomCode && currentPlayerId && db) {
                db.ref('rooms/' + currentRoomCode + '/players/' + currentPlayerId).remove()
                    .catch(error => console.error('Cleanup error:', error));
            }
        });

        // Initialize - tampilkan lobby screen
        showScreen('lobby');
        
        // Initialize Firebase saat page load
        setTimeout(() => {
            initializeFirebase();
        }, 1000);
        
        console.log('üéÆ Game initialized');
    </script>
</body>
</html>
